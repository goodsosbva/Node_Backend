<h1>{{title}}</h1>
{{#with post}}
<h2 class="text-xl">{{title}}</h2>
<div>
  creatUser :
  <b>{{writer}}</b>
</div>
<div>
  조회수: {{hits}} | createAt : {{dateString createDt}}
  <button onClick="modifyPost()">수정</button>
  <button onClick="deletePost()">삭제</button>
</div>

<div>
  <pre>{{content}}</pre>
</div>

<section>
  <div>
    <h3>{{comments.length}}개의 댓글이 있습니다.</h3>
  </div>

  <form method="post" action="/write-comment">
    <input type="hidden" name="id" value="{{_id}}" />
    <div>
      <div>
        <input type="text" name="이름" id="comment" placeholder="이름" />
        <input type="text" name="비밀번호" id="comment" placeholder="비밀번호" />
      </div>
      <div>
        <textarea cols="40" rows="3" name="comment" placeholder="댓글을 입력하세요."></textarea>
        <br /><br /><button>댓글 쓰기</button>
      </div>
    </div>
  </form>
</section>

<section>
  {{#each comments}}
  <div>
    <div>createUser: <b>{{name}}</b></div>
    <div>
      createAt: {{dateString createDt}}
      <button onClick="deleteComment('{{_id}}')">삭제</button>
    </div>
    <div>
      <pre>{{comment}}</pre>
    </div>
  </div>
  {{/each}}
</section>

{{/with}}
<footer>
  <div>
    <a href="/">목록</a>
  </div>
</footer>
<script>
  // 공통 옵션 설정
  const postOption = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
  };

  // 게시글 수정 함수
  async function modifyPost() {
    const password = prompt('비밀번호를 입력하세요.');
    if (!password) {
      return;
    }

    try {
      const result = await fetch('/modify-post', {
        ...postOption,
        body: JSON.stringify({
          id: '{{post._id}}',
          password: password,
        }),
      });

      const data = await result.json();

      if (data.isExist) {
        document.location = '/modify/{{post._id}}';
      } else {
        alert('비밀번호가 일치하지 않습니다.');
      }
    } catch (error) {
      console.error('수정 요청 중 오류 발생:', error);
      alert('수정 요청 중 오류가 발생했습니다.');
    }
  }

  // 게시글 삭제 함수
  async function deletePost() {
    const deleteOption = {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    };

    const password = prompt('if you want to delete post then 비밀번호를 입력하세요.');

    if (!password) {
      return;
    }

    const result = await fetch('/delete', {
      ...deleteOption,
      body: JSON.stringify({
        id: '{{post._id}}',
        password: password,
      }),
    });

    const data = await result.json();
    if (!data.isSuccess) {
      alert('delete failed, please check password');
      return;
    }

    document.location = '/';
  }

  async function deleteComment(idx) {
    const password = prompt('if you want to delete comment then 비밀번호를 입력하세요.');

    if (!password) {
      return;
    }

    const result = await fetch('/delete-comment', {
      ...deleteOption,
      body: JSON.stringify({
        id: '{{post._id}}',
        password: password,
      }),
    });

    const data = await result.json();
    if (!data.isSuccess) {
      alert('delete failed, please check password');
      return;
    }

    alert('delete success');
    document.location.reload();
  }
</script>
